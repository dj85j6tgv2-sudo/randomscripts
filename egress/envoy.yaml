# envoy.yaml
# Generated from egress-allowlist.yaml
#
# This is an example output - in production, generate this using:
#   python generate-envoy-config.py -a egress-allowlist.yaml -t envoy.yaml.j2 -o envoy.yaml
#
# Resolved hostnames (example IPs for testing):
#   internal-redis.net.intra -> 10.50.100.25
#   kafka.internal.corp -> 10.20.30.40

admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901

static_resources:
  listeners:
    # =========================================================================
    # HTTP PROXY LISTENER (:15000)
    # Handles HTTP/HTTPS via HTTP_PROXY environment variable
    # =========================================================================
    - name: http_proxy
      address:
        socket_address:
          address: 127.0.0.1
          port_value: 15000
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: egress_http
                http_protocol_options:
                  allow_absolute_url: true
                upgrade_configs:
                  - upgrade_type: CONNECT
                    connect_config: {}

                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          listener: "http_proxy"
                          method: "%REQ(:METHOD)%"
                          destination: "%REQ(:AUTHORITY)%"
                          response_code: "%RESPONSE_CODE%"
                          response_flags: "%RESPONSE_FLAGS%"
                          bytes_rx: "%BYTES_RECEIVED%"
                          bytes_tx: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"

                route_config:
                  name: proxy_routes
                  virtual_hosts:
                    # ─────────────────────────────────────────
                    # ALLOWED HTTP/HTTPS DESTINATIONS
                    # ─────────────────────────────────────────

                    # GitHub APIs (multiple domains in one rule)
                    - name: api_github_com_443
                      domains:
                        - "api.github.com"
                        - "api.github.com:443"
                        - "raw.githubusercontent.com"
                        - "raw.githubusercontent.com:443"
                        - "gist.githubusercontent.com"
                        - "gist.githubusercontent.com:443"
                      routes:
                        - match:
                            connect_matcher: {}
                          route:
                            cluster: dynamic_forward_proxy
                            upgrade_configs:
                              - upgrade_type: CONNECT
                                connect_config: {}
                        - match:
                            prefix: "/"
                          route:
                            cluster: dynamic_forward_proxy

                    # Monitoring services (wildcard domain)
                    - name: monitoring_internal_443
                      domains:
                        - "*.monitoring.internal"
                      routes:
                        - match:
                            connect_matcher: {}
                          route:
                            cluster: dynamic_forward_proxy
                            upgrade_configs:
                              - upgrade_type: CONNECT
                                connect_config: {}
                        - match:
                            prefix: "/"
                          route:
                            cluster: dynamic_forward_proxy

                    # Internal REST API (multiple endpoints for PRD)
                    - name: internal_api_corp_local_80
                      domains:
                        - "internal-api.corp.local"
                        - "internal-api.corp.local:80"
                        - "internal-api-legacy.corp.local"
                        - "internal-api-legacy.corp.local:80"
                        - "api.corp.local"
                        - "api.corp.local:80"
                      routes:
                        - match:
                            connect_matcher: {}
                          route:
                            cluster: dynamic_forward_proxy
                            upgrade_configs:
                              - upgrade_type: CONNECT
                                connect_config: {}
                        - match:
                            prefix: "/"
                          route:
                            cluster: dynamic_forward_proxy

                    # ─────────────────────────────────────────
                    # DEFAULT DENY
                    # ─────────────────────────────────────────
                    - name: deny_all
                      domains: ["*"]
                      routes:
                        - match:
                            connect_matcher: {}
                          direct_response:
                            status: 403
                            body:
                              inline_string: '{"error":"egress_denied","listener":"http_proxy"}'
                          response_headers_to_add:
                            - header:
                                key: content-type
                                value: application/json
                        - match:
                            prefix: "/"
                          direct_response:
                            status: 403
                            body:
                              inline_string: '{"error":"egress_denied","listener":"http_proxy"}'
                          response_headers_to_add:
                            - header:
                                key: content-type
                                value: application/json

                http_filters:
                  - name: envoy.filters.http.dynamic_forward_proxy
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.FilterConfig
                      dns_cache_config:
                        name: dynamic_forward_proxy_cache
                        dns_lookup_family: V4_ONLY
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

    # =========================================================================
    # TRANSPARENT TCP PROXY LISTENER (:15001)
    # Handles TCP traffic intercepted by iptables
    # Uses filter_chain_match with prefix_ranges for O(1) destination IP+port matching
    # =========================================================================
    - name: listener_tcp
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 15001
      access_log:
        - name: envoy.access_loggers.file
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
            path: /app/envoy/logs/all_tcp.log
            log_format:
              json_format:
                timestamp: "%START_TIME%"
                destination: "%DOWNSTREAM_LOCAL_ADDRESS%"
                source: "%DOWNSTREAM_REMOTE_ADDRESS%"
                upstream: "%UPSTREAM_HOST%"
                response_flags: "%RESPONSE_FLAGS%"
      listener_filters:
        # Capture original destination IP:port from iptables REDIRECT/TPROXY
        - name: envoy.filters.listener.original_dst
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst

      filter_chains:
        # ─────────────────────────────────────────
        # Chain 1: Allow Redis cluster with port range 30000-30999
        # Resolved IPs: internal-redis.net.intra, 10.50.100.26, 10.50.100.27
        # ─────────────────────────────────────────
        - name: "allow_redis_cluster_30000_30999"
          filter_chain_match:
            destination_port_range:
              start: 30000
              end: 30999
            # prefix_ranges matches DESTINATION IP in transparent mode
            prefix_ranges:
              - address_prefix: "10.50.100.25"
                prefix_len: 32
              - address_prefix: "10.50.100.26"
                prefix_len: 32
              - address_prefix: "10.50.100.27"
                prefix_len: 32
          filters:
            - name: envoy.filters.network.tcp_proxy
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
                stat_prefix: tcp_redis
                cluster: original_dst
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          decision: "ALLOWED"
                          rule: "redis_cluster_30000_30999"
                          destination: "%DOWNSTREAM_LOCAL_ADDRESS%"
                          source: "%DOWNSTREAM_REMOTE_ADDRESS%"
                          upstream: "%UPSTREAM_HOST%"
                          response_flags: "%RESPONSE_FLAGS%"
                          bytes_rx: "%BYTES_RECEIVED%"
                          bytes_tx: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"

        # ─────────────────────────────────────────
        # Chain 2: Allow Kafka 10.20.30.40:9093
        # ─────────────────────────────────────────
        - name: "allow_kafka_10_20_30_40_9093"
          filter_chain_match:
            destination_port: 9093
            prefix_ranges:
              - address_prefix: "10.20.30.40"
                prefix_len: 32
          filters:
            - name: envoy.filters.network.tcp_proxy
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
                stat_prefix: tcp_kafka
                cluster: original_dst
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          decision: "ALLOWED"
                          rule: "kafka_cluster"
                          destination: "%DOWNSTREAM_LOCAL_ADDRESS%"
                          source: "%DOWNSTREAM_REMOTE_ADDRESS%"
                          upstream: "%UPSTREAM_HOST%"
                          response_flags: "%RESPONSE_FLAGS%"
                          bytes_rx: "%BYTES_RECEIVED%"
                          bytes_tx: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"

        # ─────────────────────────────────────────
        # Chain 3: Default DENY (catch-all)
        # ─────────────────────────────────────────
        - name: "default_deny_all"
          filters:
            - name: envoy.filters.network.rbac
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.rbac.v3.RBAC
                stat_prefix: rbac_deny_all
                rules:
                  action: DENY
                  policies:
                    "deny-all-egress":
                      permissions:
                        - any: true
                      principals:
                        - any: true
            - name: envoy.filters.network.tcp_proxy
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
                stat_prefix: tcp_denied
                cluster: blackhole
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          decision: "DENIED"
                          rule: "default_deny"
                          destination: "%DOWNSTREAM_LOCAL_ADDRESS%"
                          source: "%DOWNSTREAM_REMOTE_ADDRESS%"
                          response_flags: "%RESPONSE_FLAGS%"

  clusters:
    # Dynamic forward proxy for HTTP/HTTPS
    - name: dynamic_forward_proxy
      lb_policy: CLUSTER_PROVIDED
      cluster_type:
        name: envoy.clusters.dynamic_forward_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.clusters.dynamic_forward_proxy.v3.ClusterConfig
          dns_cache_config:
            name: dynamic_forward_proxy_cache
            dns_lookup_family: V4_ONLY

    # Original destination for transparent TCP
    - name: original_dst
      type: ORIGINAL_DST
      lb_policy: CLUSTER_PROVIDED
      connect_timeout: 10s

    # Blackhole for denied traffic
    - name: blackhole
      type: STATIC
      connect_timeout: 1s
      load_assignment:
        cluster_name: blackhole
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 9901 # Envoy admin port - accepts connections

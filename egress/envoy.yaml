# envoy.yaml
# Generated from egress-allowlist.yaml
#
# This is an example output - in production, generate this using:
#   python generate-envoy-config.py -a egress-allowlist.yaml -t envoy.yaml.j2 -o envoy.yaml
#
# Resolved hostnames (example IPs for testing):
#   internal-redis.net.intra -> 10.50.100.25
#   kafka.internal.corp -> 10.20.30.40

admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901

static_resources:
  listeners:
    # =========================================================================
    # HTTP PROXY LISTENER (:15000)
    # Handles HTTP/HTTPS via HTTP_PROXY environment variable
    # =========================================================================
    - name: http_proxy
      address:
        socket_address:
          address: 127.0.0.1
          port_value: 15000
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: egress_http
                http_protocol_options:
                  allow_absolute_url: true
                upgrade_configs:
                  - upgrade_type: CONNECT
                    connect_config: {}

                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          listener: "http_proxy"
                          method: "%REQ(:METHOD)%"
                          destination: "%REQ(:AUTHORITY)%"
                          response_code: "%RESPONSE_CODE%"
                          response_flags: "%RESPONSE_FLAGS%"
                          bytes_rx: "%BYTES_RECEIVED%"
                          bytes_tx: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"

                route_config:
                  name: proxy_routes
                  virtual_hosts:
                    # ─────────────────────────────────────────
                    # ALLOWED HTTP/HTTPS DESTINATIONS
                    # ─────────────────────────────────────────

                    # GitHub API
                    - name: api_github_com_443
                      domains:
                        - "api.github.com"
                        - "api.github.com:443"
                      routes:
                        - match:
                            connect_matcher: {}
                          route:
                            cluster: dynamic_forward_proxy
                            upgrade_configs:
                              - upgrade_type: CONNECT
                                connect_config: {}
                        - match:
                            prefix: "/"
                          route:
                            cluster: dynamic_forward_proxy

                    # GitHub raw content
                    - name: raw_githubusercontent_com_443
                      domains:
                        - "raw.githubusercontent.com"
                        - "raw.githubusercontent.com:443"
                      routes:
                        - match:
                            connect_matcher: {}
                          route:
                            cluster: dynamic_forward_proxy
                            upgrade_configs:
                              - upgrade_type: CONNECT
                                connect_config: {}
                        - match:
                            prefix: "/"
                          route:
                            cluster: dynamic_forward_proxy

                    # Internal REST API
                    - name: internal_api_corp_local_80
                      domains:
                        - "internal-api.corp.local"
                        - "internal-api.corp.local:80"
                      routes:
                        - match:
                            connect_matcher: {}
                          route:
                            cluster: dynamic_forward_proxy
                            upgrade_configs:
                              - upgrade_type: CONNECT
                                connect_config: {}
                        - match:
                            prefix: "/"
                          route:
                            cluster: dynamic_forward_proxy

                    # ─────────────────────────────────────────
                    # DEFAULT DENY
                    # ─────────────────────────────────────────
                    - name: deny_all
                      domains: ["*"]
                      routes:
                        - match:
                            connect_matcher: {}
                          direct_response:
                            status: 403
                            body:
                              inline_string: '{"error":"egress_denied","listener":"http_proxy"}'
                          response_headers_to_add:
                            - header:
                                key: content-type
                                value: application/json
                        - match:
                            prefix: "/"
                          direct_response:
                            status: 403
                            body:
                              inline_string: '{"error":"egress_denied","listener":"http_proxy"}'
                          response_headers_to_add:
                            - header:
                                key: content-type
                                value: application/json

                http_filters:
                  - name: envoy.filters.http.dynamic_forward_proxy
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.FilterConfig
                      dns_cache_config:
                        name: dynamic_forward_proxy_cache
                        dns_lookup_family: V4_ONLY
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

    # =========================================================================
    # TRANSPARENT TCP PROXY LISTENER (:15001)
    # Handles TCP traffic intercepted by iptables
    # =========================================================================
    - name: transparent_tcp
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 15001
      access_log:
        # Logs ONLY denied connections (UAEX flag = RBAC Denied)
        - name: envoy.access_loggers.file
          filter:
            response_flag_filter:
              flags: ["UAEX"]
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
            path: /denied.log
            log_format:
              json_format:
                timestamp: "%START_TIME%"
                decision: "DENIED"
                original_dst: "%DOWNSTREAM_LOCAL_ADDRESS%"
                source: "%DOWNSTREAM_REMOTE_ADDRESS%"
                flag: "%RESPONSE_FLAGS%"

        # Logs ONLY allowed connections (No UAEX flag)
        - name: envoy.access_loggers.file
          filter:
            not_filter:
              response_flag_filter:
                flags: ["UAEX"]
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
            path: /access.log
            log_format:
              json_format:
                timestamp: "%START_TIME%"
                decision: "ALLOWED"
                original_dst: "%DOWNSTREAM_LOCAL_ADDRESS%"
                source: "%DOWNSTREAM_REMOTE_ADDRESS%"
                upstream: "%UPSTREAM_HOST%"
                bytes_rx: "%BYTES_RECEIVED%"
                bytes_tx: "%BYTES_SENT%"
                duration_ms: "%DURATION%"

        # Catch-all debug log
        - name: envoy.access_loggers.file
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
            path: /all_tcp.log
            log_format:
              json_format:
                timestamp: "%START_TIME%"
                dst: "%DOWNSTREAM_LOCAL_ADDRESS%"
                src: "%DOWNSTREAM_REMOTE_ADDRESS%"
                flag: "%RESPONSE_FLAGS%"
      listener_filters:
        - name: envoy.filters.listener.original_dst
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst

      filter_chains:
        - filters:
            # RBAC decides based on your policies
            - name: envoy.filters.network.rbac
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.rbac.v3.RBAC
                stat_prefix: tcp_rbac
                rules:
                  action: ALLOW
                  policies:
                    redis_cache:
                      permissions:
                        - and_rules:
                            rules:
                              - destination_ip:
                                  {
                                    address_prefix: "10.50.100.25",
                                    prefix_len: 32,
                                  }
                              - destination_port: 30672
                      principals: [{ any: true }]
                    kafka_brokers:
                      permissions:
                        - and_rules:
                            rules:
                              - destination_ip:
                                  {
                                    address_prefix: "10.20.30.0",
                                    prefix_len: 24,
                                  }
                              - destination_port: 9092
                      principals: [{ any: true }]

            # Forwarding (only happens if RBAC matches a policy)
            - name: envoy.filters.network.tcp_proxy
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
                stat_prefix: tcp_egress
                cluster: original_dst
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          decision: "%DYNAMIC_METADATA(envoy.filters.network.rbac:allowed)%"
                          destination: "%DOWNSTREAM_LOCAL_ADDRESS%"
                          source: "%DOWNSTREAM_REMOTE_ADDRESS%"
                          response_flags: "%RESPONSE_FLAGS%"
                          bytes_rx: "%BYTES_RECEIVED%"
                          bytes_tx: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"

  clusters:
    # Dynamic forward proxy for HTTP/HTTPS
    - name: dynamic_forward_proxy
      lb_policy: CLUSTER_PROVIDED
      cluster_type:
        name: envoy.clusters.dynamic_forward_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.clusters.dynamic_forward_proxy.v3.ClusterConfig
          dns_cache_config:
            name: dynamic_forward_proxy_cache
            dns_lookup_family: V4_ONLY

    # Original destination for transparent TCP
    - name: original_dst
      type: ORIGINAL_DST
      lb_policy: CLUSTER_PROVIDED
      connect_timeout: 10s

    # Blackhole for denied traffic
    - name: blackhole
      type: STATIC
      connect_timeout: 1s
      load_assignment:
        cluster_name: blackhole
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 9901 # Envoy admin port - accepts connections

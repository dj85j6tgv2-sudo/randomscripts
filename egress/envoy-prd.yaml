
admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901

static_resources:
  listeners:
    # =========================================================================
    # HTTP PROXY LISTENER (:15000)
    # Handles HTTP/HTTPS via HTTP_PROXY environment variable
    # Environment: PRD
    # =========================================================================
    - name: http_proxy
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 15000
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: egress_http
                http_protocol_options:
                  allow_absolute_url: true
                upgrade_configs:
                  - upgrade_type: CONNECT
                    connect_config: {}

                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          listener: "http_proxy"
                          environment: "prd"
                          method: "%REQ(:METHOD)%"
                          destination: "%REQ(:AUTHORITY)%"
                          response_code: "%RESPONSE_CODE%"
                          response_flags: "%RESPONSE_FLAGS%"
                          bytes_rx: "%BYTES_RECEIVED%"
                          bytes_tx: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"

                route_config:
                  name: proxy_routes
                  virtual_hosts:
                    # ─────────────────────────────────────────
                    # ALLOWED HTTP/HTTPS DESTINATIONS (PRD)
                    # ─────────────────────────────────────────
                    # GitHub APIs [envs: dev, stg, prd]
                    - name: "api_github_com_443"
                      domains:
                        - "api.github.com"
                        - "api.github.com:443"
                        - "raw.githubusercontent.com"
                        - "raw.githubusercontent.com:443"
                        - "gist.githubusercontent.com"
                        - "gist.githubusercontent.com:443"
                      routes:
                        - match:
                            connect_matcher: {}
                          route:
                            cluster: dynamic_forward_proxy
                            upgrade_configs:
                              - upgrade_type: CONNECT
                                connect_config: {}
                        - match:
                            prefix: "/"
                          route:
                            cluster: dynamic_forward_proxy

                    # Internal REST API - PRD (multiple endpoints) [envs: prd]
                    - name: "internal_api_corp_local_80"
                      domains:
                        - "internal-api.corp.local"
                        - "internal-api.corp.local:80"
                        - "internal-api-legacy.corp.local"
                        - "internal-api-legacy.corp.local:80"
                        - "api.corp.local"
                        - "api.corp.local:80"
                      routes:
                        - match:
                            connect_matcher: {}
                          route:
                            cluster: dynamic_forward_proxy
                            upgrade_configs:
                              - upgrade_type: CONNECT
                                connect_config: {}
                        - match:
                            prefix: "/"
                          route:
                            cluster: dynamic_forward_proxy

                    # Partner API - Production [envs: prd]
                    - name: "partner_api_external_com_443"
                      domains:
                        - "partner-api.external.com"
                        - "partner-api.external.com:443"
                      routes:
                        - match:
                            connect_matcher: {}
                          route:
                            cluster: dynamic_forward_proxy
                            upgrade_configs:
                              - upgrade_type: CONNECT
                                connect_config: {}
                        - match:
                            prefix: "/"
                          route:
                            cluster: dynamic_forward_proxy

                    # All monitoring subdomains (Grafana, Prometheus, etc) [envs: dev, stg, prd]
                    - name: "__monitoring_internal_443"
                      domains:
                        - "*.monitoring.internal"
                      routes:
                        - match:
                            connect_matcher: {}
                          route:
                            cluster: dynamic_forward_proxy
                            upgrade_configs:
                              - upgrade_type: CONNECT
                                connect_config: {}
                        - match:
                            prefix: "/"
                          route:
                            cluster: dynamic_forward_proxy

                    # ─────────────────────────────────────────
                    # DEFAULT DENY
                    # ─────────────────────────────────────────
                    - name: deny_all
                      domains: ["*"]
                      routes:
                        - match:
                            connect_matcher: {}
                          direct_response:
                            status: 403
                            body:
                              inline_string: '{"error":"egress_denied","listener":"http_proxy","environment":"prd"}'
                          response_headers_to_add:
                            - header:
                                key: content-type
                                value: application/json
                        - match:
                            prefix: "/"
                          direct_response:
                            status: 403
                            body:
                              inline_string: '{"error":"egress_denied","listener":"http_proxy","environment":"prd"}'
                          response_headers_to_add:
                            - header:
                                key: content-type
                                value: application/json

                http_filters:
                  - name: envoy.filters.http.dynamic_forward_proxy
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.FilterConfig
                      dns_cache_config:
                        name: dynamic_forward_proxy_cache
                        dns_lookup_family: V4_ONLY
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

    # =========================================================================
    # TRANSPARENT TCP PROXY LISTENER (:15001)
    # Handles TCP traffic intercepted by iptables
    # Environment: PRD
    # =========================================================================
    - name: transparent_tcp
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 15001
      transparent: true
      listener_filters:
        - name: envoy.filters.listener.original_dst
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst
        - name: envoy.filters.listener.tls_inspector
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector

      filter_chains:
        # ─────────────────────────────────────────
        # ALLOWED TCP DESTINATIONS (PRD)
        # ─────────────────────────────────────────
        # Redis cluster - PRD (HA) [envs: prd]
        - name: "allow_redis_prd_master_internal_30000_30999"
          filter_chain_match:
            destination_port_range:
              start: 30000
              end: 30999
            prefix_ranges:
              - address_prefix: "10.50.250.25"
                prefix_len: 32
              - address_prefix: "10.50.250.26"
                prefix_len: 32
              - address_prefix: "10.50.250.27"
                prefix_len: 32
          filters:
            - name: envoy.filters.network.tcp_proxy
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
                stat_prefix: "tcp_redis_prd_master_internal_30000_30999"
                cluster: original_dst
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          listener: "transparent_tcp"
                          environment: "prd"
                          decision: "ALLOWED"
                          rule: "Redis cluster - PRD (HA)"
                          destination: "%UPSTREAM_HOST%"
                          bytes_rx: "%BYTES_RECEIVED%"
                          bytes_tx: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"

        # Kafka brokers subnet - PRD [envs: prd]
        - name: "allow_10_20_30_0_24_9092"
          filter_chain_match:
            destination_port: 9092
            prefix_ranges:
              - address_prefix: "10.20.30.0"
                prefix_len: 24
          filters:
            - name: envoy.filters.network.tcp_proxy
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
                stat_prefix: "tcp_10_20_30_0_24_9092"
                cluster: original_dst
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          listener: "transparent_tcp"
                          environment: "prd"
                          decision: "ALLOWED"
                          rule: "Kafka brokers subnet - PRD"
                          destination: "%UPSTREAM_HOST%"
                          bytes_rx: "%BYTES_RECEIVED%"
                          bytes_tx: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"

        # PostgreSQL database - PRD [envs: prd]
        - name: "allow_172_16_20_5_5432"
          filter_chain_match:
            destination_port: 5432
            prefix_ranges:
              - address_prefix: "172.16.20.5"
                prefix_len: 32
          filters:
            - name: envoy.filters.network.tcp_proxy
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
                stat_prefix: "tcp_172_16_20_5_5432"
                cluster: original_dst
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          listener: "transparent_tcp"
                          environment: "prd"
                          decision: "ALLOWED"
                          rule: "PostgreSQL database - PRD"
                          destination: "%UPSTREAM_HOST%"
                          bytes_rx: "%BYTES_RECEIVED%"
                          bytes_tx: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"

        # ─────────────────────────────────────────
        # DEFAULT DENY
        # ─────────────────────────────────────────
        - filters:
            - name: envoy.filters.network.tcp_proxy
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
                stat_prefix: tcp_denied
                cluster: blackhole
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          listener: "transparent_tcp"
                          environment: "prd"
                          decision: "DENIED"
                          destination: "%UPSTREAM_HOST%"
                          sni: "%REQUESTED_SERVER_NAME%"

  clusters:
    # Dynamic forward proxy for HTTP/HTTPS
    - name: dynamic_forward_proxy
      lb_policy: CLUSTER_PROVIDED
      cluster_type:
        name: envoy.clusters.dynamic_forward_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.clusters.dynamic_forward_proxy.v3.ClusterConfig
          dns_cache_config:
            name: dynamic_forward_proxy_cache
            dns_lookup_family: V4_ONLY

    # Original destination for transparent TCP
    - name: original_dst
      type: ORIGINAL_DST
      lb_policy: CLUSTER_PROVIDED
      connect_timeout: 10s

    # Blackhole for denied traffic
    - name: blackhole
      type: STATIC
      connect_timeout: 1s
      load_assignment:
        cluster_name: blackhole
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 9901

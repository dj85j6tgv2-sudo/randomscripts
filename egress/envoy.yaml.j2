{# envoy.yaml.j2 #}
{# Envoy Egress Control Plane Configuration Template #}
{# Generated from egress-allowlist.yaml for environment: {{ target_env | upper }} #}

admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901

static_resources:
  listeners:
    # =========================================================================
    # HTTP PROXY LISTENER (:15000)
    # Handles HTTP/HTTPS via HTTP_PROXY environment variable
    # Environment: {{ target_env | upper }}
    # =========================================================================
    - name: http_proxy
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 15000
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: egress_http
                http_protocol_options:
                  allow_absolute_url: true
                upgrade_configs:
                  - upgrade_type: CONNECT
                    connect_config: {}

                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          listener: "http_proxy"
                          environment: "{{ target_env }}"
                          method: "%REQ(:METHOD)%"
                          destination: "%REQ(:AUTHORITY)%"
                          response_code: "%RESPONSE_CODE%"
                          response_flags: "%RESPONSE_FLAGS%"
                          bytes_rx: "%BYTES_RECEIVED%"
                          bytes_tx: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"

                route_config:
                  name: proxy_routes
                  virtual_hosts:
                    # ─────────────────────────────────────────
                    # ALLOWED HTTP/HTTPS DESTINATIONS ({{ target_env | upper }})
                    # ─────────────────────────────────────────
{% for rule in http_rules %}
                    # {{ rule.description | default('HTTP rule') }} [envs: {{ rule.envs | join(', ') }}]
                    - name: "{{ rule.name }}"
                      domains:
{% for domain in rule.domains %}
{% if '*' in domain %}
                        - "{{ domain }}"
{% else %}
                        - "{{ domain }}"
                        - "{{ domain }}:{{ rule.port }}"
{% endif %}
{% endfor %}
                      routes:
                        - match:
                            connect_matcher: {}
                          route:
                            cluster: dynamic_forward_proxy
                            upgrade_configs:
                              - upgrade_type: CONNECT
                                connect_config: {}
                        - match:
                            prefix: "/"
                          route:
                            cluster: dynamic_forward_proxy

{% endfor %}
                    # ─────────────────────────────────────────
                    # DEFAULT DENY
                    # ─────────────────────────────────────────
                    - name: deny_all
                      domains: ["*"]
                      routes:
                        - match:
                            connect_matcher: {}
                          direct_response:
                            status: 403
                            body:
                              inline_string: '{"error":"egress_denied","listener":"http_proxy","environment":"{{ target_env }}"}'
                          response_headers_to_add:
                            - header:
                                key: content-type
                                value: application/json
                        - match:
                            prefix: "/"
                          direct_response:
                            status: 403
                            body:
                              inline_string: '{"error":"egress_denied","listener":"http_proxy","environment":"{{ target_env }}"}'
                          response_headers_to_add:
                            - header:
                                key: content-type
                                value: application/json

                http_filters:
                  - name: envoy.filters.http.dynamic_forward_proxy
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.dynamic_forward_proxy.v3.FilterConfig
                      dns_cache_config:
                        name: dynamic_forward_proxy_cache
                        dns_lookup_family: V4_ONLY
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

    # =========================================================================
    # TRANSPARENT TCP PROXY LISTENER (:15001)
    # Handles TCP traffic intercepted by iptables
    # Environment: {{ target_env | upper }}
    # =========================================================================
    - name: transparent_tcp
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 15001
      transparent: true
      listener_filters:
        - name: envoy.filters.listener.original_dst
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst
        - name: envoy.filters.listener.tls_inspector
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector

      filter_chains:
        # ─────────────────────────────────────────
        # ALLOWED TCP DESTINATIONS ({{ target_env | upper }})
        # ─────────────────────────────────────────
{% for rule in tcp_rules %}
        # {{ rule.description | default('TCP rule') }} [envs: {{ rule.envs | join(', ') }}]
{% if rule.port_range %}
        # filter_chain_match does not support destination_port_range; port range
        # {{ rule.port_range.start }}-{{ rule.port_range.end }} is enforced via RBAC filter below.
{% endif %}
        - name: "{{ rule.name }}"
          filter_chain_match:
{% if not rule.port_range %}
            destination_port: {{ rule.port }}
{% endif %}
            prefix_ranges:
{% for ip in rule.ip_addresses %}
              - address_prefix: "{{ ip.address }}"
                prefix_len: {{ ip.prefix_len }}
{% endfor %}
          filters:
{% if rule.port_range %}
            - name: envoy.filters.network.rbac
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.rbac.v3.RBAC
                stat_prefix: "rbac_{{ rule.stat_name }}"
                rules:
                  action: ALLOW
                  policies:
                    allow_port_range:
                      permissions:
                        - destination_port_range:
                            start: {{ rule.port_range.start }}
                            end: {{ rule.port_range.end + 1 }}
                      principals:
                        - any: true
{% endif %}
            - name: envoy.filters.network.tcp_proxy
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
                stat_prefix: "tcp_{{ rule.stat_name }}"
                cluster: original_dst
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          listener: "transparent_tcp"
                          environment: "{{ target_env }}"
                          decision: "ALLOWED"
                          rule: "{{ rule.description | default('TCP rule') }}"
                          destination: "%UPSTREAM_HOST%"
                          bytes_rx: "%BYTES_RECEIVED%"
                          bytes_tx: "%BYTES_SENT%"
                          duration_ms: "%DURATION%"

{% endfor %}
        # ─────────────────────────────────────────
        # DEFAULT DENY
        # ─────────────────────────────────────────
        - filters:
            - name: envoy.filters.network.tcp_proxy
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
                stat_prefix: tcp_denied
                cluster: blackhole
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          listener: "transparent_tcp"
                          environment: "{{ target_env }}"
                          decision: "DENIED"
                          destination: "%UPSTREAM_HOST%"
                          sni: "%REQUESTED_SERVER_NAME%"

  clusters:
    # Dynamic forward proxy for HTTP/HTTPS
    - name: dynamic_forward_proxy
      lb_policy: CLUSTER_PROVIDED
      cluster_type:
        name: envoy.clusters.dynamic_forward_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.clusters.dynamic_forward_proxy.v3.ClusterConfig
          dns_cache_config:
            name: dynamic_forward_proxy_cache
            dns_lookup_family: V4_ONLY

    # Original destination for transparent TCP
    - name: original_dst
      type: ORIGINAL_DST
      lb_policy: CLUSTER_PROVIDED
      connect_timeout: 10s

    # Blackhole for denied traffic
    - name: blackhole
      type: STATIC
      connect_timeout: 1s
      load_assignment:
        cluster_name: blackhole
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 9901
